#!/bin/bash

# Pre-commit hook to:
# 1. Prevent commits directly to main/master branch
# 2. Run lint-staged (formats with Prettier and lints with ESLint)
# 3. Run test suite

set -e

# Get the current branch name
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# Check if we're on main or master
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âŒ ERROR: Direct commits to '$current_branch' branch are not allowed!"
  echo ""
  echo "Please create a feature branch first:"
  echo "  git checkout -b feature/your-feature-name"
  echo ""
  echo "Or if you really need to commit to main (e.g., hotfix), use:"
  echo "  git commit --no-verify"
  echo ""
  echo "âš ï¸  Note: Using --no-verify bypasses this safety check."
  exit 1
fi

echo "ğŸ” Running lint-staged (formatting and linting staged files)..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "âŒ Lint-staged failed. Please fix the issues and try again."
  echo "   Note: ESLint includes cyclomatic complexity checking (max: 30)"
  exit 1
fi

echo "âœ… Lint-staged passed"
echo ""
echo "ğŸ§ª Running test suite..."
npm test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix failing tests before committing."
  exit 1
fi

echo "âœ… All tests passed"
echo ""
echo "âœ¨ Pre-commit checks passed!"

exit 0

