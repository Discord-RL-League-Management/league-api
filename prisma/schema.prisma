generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GamePlatform {
  STEAM
  EPIC
  XBL
  PSN
  SWITCH
}

enum Game {
  ROCKET_LEAGUE
}

enum OutboxStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TrackerScrapingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model User {
  id            String  @id
  username      String
  discriminator String?
  globalName    String?
  avatar        String?
  email         String?

  accessToken  String? @db.Text
  refreshToken String? @db.Text

  isBanned  Boolean @default(false)
  isDeleted Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime @default(now())

  // Relationships
  guildMembers     GuildMember[]
  trackers         Tracker[]
  enteredSnapshots TrackerSnapshot[]

  @@index([isBanned])
  @@index([isDeleted])
  @@map("users")
}

model Guild {
  id          String    @id @db.VarChar(20) // Discord snowflake ID
  name        String    @db.VarChar(100)
  icon        String?   @db.VarChar(50)
  ownerId     String    @db.VarChar(20) // Discord user snowflake ID
  memberCount Int       @default(0)
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?
  isActive    Boolean   @default(true)

  // Relationships
  members GuildMember[]

  // Indexes for performance
  @@index([isActive])
  @@index([joinedAt])
  @@index([ownerId])
  @@map("guilds")
}

model GuildMember {
  id       String   @id @default(cuid())
  userId   String   @db.VarChar(20) // Discord user snowflake ID
  guildId  String   @db.VarChar(20) // Discord guild snowflake ID
  username String   @db.VarChar(100)
  nickname String?  @db.VarChar(100) // Guild-specific nickname
  roles    String[] // Array of Discord role IDs

  isBanned  Boolean @default(false) // Guild-specific ban
  isDeleted Boolean @default(false)

  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@unique([userId, guildId])
  @@index([guildId])
  @@index([userId])
  @@index([joinedAt])
  @@index([isBanned])
  @@index([isDeleted])
  @@map("guild_members")
}

model Tracker {
  id               String                @id @default(cuid())
  url              String                @unique
  game             Game                  @default(ROCKET_LEAGUE)
  platform         GamePlatform
  username         String
  userId           String                @unique // The player this tracker belongs to (one-to-one relationship)
  displayName      String?
  isActive         Boolean               @default(true)
  isDeleted        Boolean               @default(false)
  lastScrapedAt    DateTime?
  scrapingStatus   TrackerScrapingStatus @default(PENDING)
  scrapingError    String?               @db.Text
  scrapingAttempts Int                   @default(0)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  // Relationships
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots    TrackerSnapshot[]
  seasons      TrackerSeason[]
  scrapingLogs TrackerScrapingLog[]

  @@index([userId])
  @@index([platform])
  @@index([isActive])
  @@index([isDeleted])
  @@index([scrapingStatus])
  @@index([lastScrapedAt])
  @@map("trackers")
}

model TrackerSnapshot {
  id           String   @id @default(cuid())
  trackerId    String
  capturedAt   DateTime @default(now())
  seasonNumber Int?
  enteredBy    String   @db.VarChar(20)

  // MMR values (integers)
  ones   Int?
  twos   Int?
  threes Int?
  fours  Int?

  // Games played
  onesGamesPlayed   Int?
  twosGamesPlayed   Int?
  threesGamesPlayed Int?
  foursGamesPlayed  Int?

  // Relationships
  tracker       Tracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)
  enteredByUser User    @relation(fields: [enteredBy], references: [id], onDelete: Restrict)

  @@index([trackerId])
  @@index([seasonNumber])
  @@index([capturedAt])
  @@index([trackerId, capturedAt])
  @@index([trackerId, seasonNumber])
  @@map("tracker_snapshots")
}

model Outbox {
  id           String       @id @default(cuid())
  sourceType   String       @db.VarChar(50)
  sourceId     String
  eventType    String       @db.VarChar(100)
  payload      Json
  status       OutboxStatus @default(PENDING)
  processedAt  DateTime?
  errorMessage String?      @db.Text
  retryCount   Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([status, createdAt])
  @@index([sourceType, sourceId])
  @@index([sourceType, status])
  @@map("outbox")
}

model ProcessedEvent {
  id          String   @id @default(cuid())
  eventKey    String   @unique
  entityType  String?  @db.VarChar(50)
  entityId    String?
  metadata    Json?
  processedAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([processedAt])
  @@map("processed_events")
}

model ActivityLog {
  id         String   @id @default(cuid())
  entityType String   @db.VarChar(50)
  entityId   String
  eventType  String   @db.VarChar(100)
  action     String   @db.VarChar(50)
  userId     String?  @db.VarChar(20)
  guildId    String?  @db.VarChar(20)
  changes    Json?
  metadata   Json?
  timestamp  DateTime @default(now())

  @@index([entityType, entityId, timestamp])
  @@index([userId, timestamp])
  @@index([guildId, timestamp])
  @@index([eventType, timestamp])
  @@map("activity_logs")
}

model Settings {
  id            String   @id @default(cuid())
  ownerType     String   @db.VarChar(50)
  ownerId       String
  settings      Json
  schemaVersion Int      @default(1)
  configVersion String?  @db.VarChar(20)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([ownerType, ownerId])
  @@index([ownerType, ownerId])
  @@map("settings")
}

model EntityVisibility {
  id         String   @id @default(cuid())
  entityType String   @db.VarChar(50)
  entityId   String
  targetType String   @db.VarChar(50)
  targetId   String   @db.VarChar(20)
  createdAt  DateTime @default(now())

  @@unique([entityType, entityId, targetType, targetId])
  @@index([entityType, entityId])
  @@index([targetType, targetId])
  @@map("entity_visibility")
}

model TrackerSeason {
  id           String   @id @default(cuid())
  trackerId    String
  seasonNumber Int
  seasonName   String?
  playlist1v1  Json?
  playlist2v2  Json?
  playlist3v3  Json?
  playlist4v4  Json?
  scrapedAt    DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  tracker Tracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)

  @@unique([trackerId, seasonNumber])
  @@index([trackerId])
  @@index([seasonNumber])
  @@map("tracker_seasons")
}

model TrackerScrapingLog {
  id             String                @id @default(cuid())
  trackerId      String
  status         TrackerScrapingStatus
  seasonsScraped Int
  seasonsFailed  Int
  errorMessage   String?               @db.Text
  startedAt      DateTime
  completedAt    DateTime?
  metadata       Json?

  // Relationships
  tracker Tracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)

  @@index([trackerId, startedAt])
  @@index([status])
  @@map("tracker_scraping_logs")
}
