generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GamePlatform {
  STEAM
  EPIC
  XBL
  PSN
  SWITCH
}

enum Game {
  ROCKET_LEAGUE
  DOTA_2
}

enum LeagueStatus {
  ACTIVE
  PAUSED
  ARCHIVED
  CANCELLED
}

enum OutboxStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TrackerScrapingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum PlayerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum LeagueMemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_APPROVAL
}

enum LeagueMemberRole {
  MEMBER
  ADMIN
  MODERATOR
}

enum TeamRole {
  CAPTAIN
  MEMBER
  SUBSTITUTE
}

enum TeamMembershipStatus {
  ACTIVE
  INACTIVE
  REMOVED
}

enum TeamMembershipType {
  PERMANENT
  TEMPORARY
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FORFEIT
}

enum MatchParticipantType {
  TEAM_MEMBER
  SUBSTITUTE
  GUEST
}

enum TournamentStatus {
  UPCOMING
  REGISTRATION_OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ParticipantStatus {
  ACTIVE
  ELIMINATED
  WITHDRAWN
}

enum OrganizationMemberRole {
  GENERAL_MANAGER
  MEMBER
}

enum OrganizationMemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  REMOVED
}

model User {
  id            String  @id
  username      String
  discriminator String?
  globalName    String?
  avatar        String?
  email         String?

  accessToken  String? @db.Text
  refreshToken String? @db.Text

  isBanned  Boolean @default(false)
  isDeleted Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime @default(now())

  // Relationships
  guildMembers     GuildMember[]
  trackers         Tracker[]
  enteredSnapshots TrackerSnapshot[]
  players          Player[]

  @@index([isBanned])
  @@index([isDeleted])
  @@map("users")
}

model Guild {
  id          String    @id @db.VarChar(20) // Discord snowflake ID
  name        String    @db.VarChar(100)
  icon        String?   @db.VarChar(50)
  ownerId     String    @db.VarChar(20) // Discord user snowflake ID
  memberCount Int       @default(0)
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?
  isActive    Boolean   @default(true)

  // Relationships
  members GuildMember[]
  leagues League[]
  players Player[]

  // Indexes for performance
  @@index([isActive])
  @@index([joinedAt])
  @@index([ownerId])
  @@map("guilds")
}

model GuildMember {
  id       String   @id @default(cuid())
  userId   String   @db.VarChar(20) // Discord user snowflake ID
  guildId  String   @db.VarChar(20) // Discord guild snowflake ID
  username String   @db.VarChar(100)
  nickname String?  @db.VarChar(100) // Guild-specific nickname
  roles    String[] // Array of Discord role IDs

  isBanned  Boolean @default(false) // Guild-specific ban
  isDeleted Boolean @default(false)

  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@unique([userId, guildId])
  @@index([guildId])
  @@index([userId])
  @@index([joinedAt])
  @@index([isBanned])
  @@index([isDeleted])
  @@map("guild_members")
}

model Tracker {
  id               String                @id @default(cuid())
  url              String                @unique
  game             Game                  @default(ROCKET_LEAGUE)
  platform         GamePlatform
  username         String
  userId           String // The player this tracker belongs to (allows multiple trackers per user)
  displayName      String?
  isActive         Boolean               @default(true)
  isDeleted        Boolean               @default(false)
  lastScrapedAt    DateTime?
  scrapingStatus   TrackerScrapingStatus @default(PENDING)
  scrapingError    String?               @db.Text
  scrapingAttempts Int                   @default(0)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  // Relationships
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots    TrackerSnapshot[]
  seasons      TrackerSeason[]
  scrapingLogs TrackerScrapingLog[]
  primaryFor   Player[]             @relation("PlayerPrimaryTracker")

  @@index([userId])
  @@index([platform])
  @@index([isActive])
  @@index([isDeleted])
  @@index([scrapingStatus])
  @@index([lastScrapedAt])
  @@map("trackers")
}

model TrackerSnapshot {
  id           String   @id @default(cuid())
  trackerId    String
  capturedAt   DateTime @default(now())
  seasonNumber Int?
  enteredBy    String   @db.VarChar(20)

  // MMR values (integers)
  ones   Int?
  twos   Int?
  threes Int?
  fours  Int?

  // Games played
  onesGamesPlayed   Int?
  twosGamesPlayed   Int?
  threesGamesPlayed Int?
  foursGamesPlayed  Int?

  // Relationships
  tracker       Tracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)
  enteredByUser User    @relation(fields: [enteredBy], references: [id], onDelete: Restrict)

  @@index([trackerId])
  @@index([seasonNumber])
  @@index([capturedAt])
  @@index([trackerId, capturedAt])
  @@index([trackerId, seasonNumber])
  @@map("tracker_snapshots")
}

model Outbox {
  id           String       @id @default(cuid())
  sourceType   String       @db.VarChar(50)
  sourceId     String
  eventType    String       @db.VarChar(100)
  payload      Json
  status       OutboxStatus @default(PENDING)
  processedAt  DateTime?
  errorMessage String?      @db.Text
  retryCount   Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([status, createdAt])
  @@index([sourceType, sourceId])
  @@index([sourceType, status])
  @@map("outbox")
}

model ProcessedEvent {
  id          String   @id @default(cuid())
  eventKey    String   @unique
  entityType  String?  @db.VarChar(50)
  entityId    String?
  metadata    Json?
  processedAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([processedAt])
  @@map("processed_events")
}

model ActivityLog {
  id         String   @id @default(cuid())
  entityType String   @db.VarChar(50)
  entityId   String
  eventType  String   @db.VarChar(100)
  action     String   @db.VarChar(50)
  userId     String?  @db.VarChar(20)
  guildId    String?  @db.VarChar(20)
  changes    Json?
  metadata   Json?
  timestamp  DateTime @default(now())

  @@index([entityType, entityId, timestamp])
  @@index([userId, timestamp])
  @@index([guildId, timestamp])
  @@index([eventType, timestamp])
  @@map("activity_logs")
}

model Settings {
  id            String   @id @default(cuid())
  ownerType     String   @db.VarChar(50)
  ownerId       String
  settings      Json
  schemaVersion Int      @default(1)
  configVersion String?  @db.VarChar(20)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([ownerType, ownerId])
  @@index([ownerType, ownerId])
  @@map("settings")
}

model EntityVisibility {
  id         String   @id @default(cuid())
  entityType String   @db.VarChar(50)
  entityId   String
  targetType String   @db.VarChar(50)
  targetId   String   @db.VarChar(20)
  createdAt  DateTime @default(now())

  @@unique([entityType, entityId, targetType, targetId])
  @@index([entityType, entityId])
  @@index([targetType, targetId])
  @@map("entity_visibility")
}

model TrackerSeason {
  id           String   @id @default(cuid())
  trackerId    String
  seasonNumber Int
  seasonName   String?
  playlist1v1  Json?
  playlist2v2  Json?
  playlist3v3  Json?
  playlist4v4  Json?
  scrapedAt    DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  tracker Tracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)

  @@unique([trackerId, seasonNumber])
  @@index([trackerId])
  @@index([seasonNumber])
  @@map("tracker_seasons")
}

model TrackerScrapingLog {
  id             String                @id @default(cuid())
  trackerId      String
  status         TrackerScrapingStatus
  seasonsScraped Int
  seasonsFailed  Int
  errorMessage   String?               @db.Text
  startedAt      DateTime
  completedAt    DateTime?
  metadata       Json?

  // Relationships
  tracker Tracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)

  @@index([trackerId, startedAt])
  @@index([status])
  @@map("tracker_scraping_logs")
}

model Player {
  id               String       @id @default(cuid())
  userId           String       @db.VarChar(20)
  guildId          String       @db.VarChar(20)
  status           PlayerStatus @default(ACTIVE)
  primaryTrackerId String?
  lastLeftLeagueAt DateTime?
  lastLeftLeagueId String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relationships
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild                  Guild                   @relation(fields: [guildId], references: [id], onDelete: Cascade)
  primaryTracker         Tracker?                @relation("PlayerPrimaryTracker", fields: [primaryTrackerId], references: [id], onDelete: SetNull)
  leagueMembers          LeagueMember[]
  teamMembers            TeamMember[]
  captainOf              Team[]                  @relation("TeamCaptain")
  matchParticipants      MatchParticipant[]
  stats                  PlayerLeagueStats[]
  ratings                PlayerLeagueRating[]
  tournamentParticipants TournamentParticipant[]
  organizationMembers    OrganizationMember[]

  @@unique([userId, guildId])
  @@index([guildId, status])
  @@index([userId])
  @@map("players")
}

model LeagueMember {
  id         String             @id @default(cuid())
  playerId   String
  leagueId   String
  status     LeagueMemberStatus @default(ACTIVE)
  role       LeagueMemberRole   @default(MEMBER)
  joinedAt   DateTime           @default(now())
  leftAt     DateTime?
  approvedBy String?            @db.VarChar(20)
  approvedAt DateTime?
  notes      String?            @db.Text
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  // Relationships
  player      Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  league      League       @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  teamMembers TeamMember[]

  @@unique([playerId, leagueId])
  @@index([leagueId, status])
  @@index([playerId, status])
  @@map("league_members")
}

model Team {
  id                 String   @id @default(cuid())
  leagueId           String
  name               String   @db.VarChar(200)
  tag                String?  @db.VarChar(20)
  description        String?  @db.Text
  captainId          String?
  organizationId     String?
  maxPlayers         Int      @default(5)
  minPlayers         Int      @default(2)
  allowEmergencySubs Boolean  @default(true)
  maxSubstitutes     Int      @default(2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relationships
  league                 League                  @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  organization           Organization?           @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  members                TeamMember[]
  captain                Player?                 @relation("TeamCaptain", fields: [captainId], references: [id], onDelete: SetNull)
  matchParticipants      MatchParticipant[]
  tournamentParticipants TournamentParticipant[]

  @@index([leagueId])
  @@index([organizationId])
  @@index([leagueId, organizationId])
  @@map("teams")
}

model TeamMember {
  id             String               @id @default(cuid())
  teamId         String
  playerId       String
  leagueId       String
  role           TeamRole             @default(MEMBER)
  status         TeamMembershipStatus @default(ACTIVE)
  membershipType TeamMembershipType   @default(PERMANENT)
  startDate      DateTime             @default(now())
  endDate        DateTime?
  joinedAt       DateTime             @default(now())
  leftAt         DateTime?
  removedBy      String?              @db.VarChar(20)
  notes          String?              @db.Text
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  // Relationships
  team              Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player            Player             @relation(fields: [playerId], references: [id], onDelete: Cascade)
  league            League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  matchParticipants MatchParticipant[]
  LeagueMember      LeagueMember?      @relation(fields: [leagueMemberId], references: [id])
  leagueMemberId    String?

  @@index([playerId, leagueId, status])
  @@index([teamId, status])
  @@index([playerId, leftAt])
  @@map("team_members")
}

model League {
  id          String       @id @default(cuid())
  guildId     String       @db.VarChar(20) // Discord guild snowflake ID
  name        String       @db.VarChar(200)
  description String?      @db.Text
  status      LeagueStatus @default(ACTIVE)
  game        Game?
  createdBy   String       @db.VarChar(20) // Discord user snowflake ID
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relationships
  guild                 Guild                   @relation(fields: [guildId], references: [id], onDelete: Cascade)
  leagueMembers         LeagueMember[]
  teams                 Team[]
  organizations         Organization[]
  organizationMembers   OrganizationMember[]
  tournaments           Tournament[]
  matches               Match[]
  playerStats           PlayerLeagueStats[]
  playerRatings         PlayerLeagueRating[]
  TournamentParticipant TournamentParticipant[]
  // series        Series[]        // Will be added when Series model is created
  TeamMember            TeamMember[]

  @@index([guildId])
  @@index([status])
  @@index([game])
  @@index([guildId, game])
  @@index([guildId, status])
  @@map("leagues")
}

model Match {
  id           String      @id @default(cuid())
  tournamentId String?
  leagueId     String
  round        Int?
  status       MatchStatus @default(SCHEDULED)
  scheduledAt  DateTime?
  playedAt     DateTime?
  winnerId     String?
  createdAt    DateTime    @default(now())

  // Relationships
  tournament   Tournament?        @relation(fields: [tournamentId], references: [id], onDelete: SetNull)
  league       League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  participants MatchParticipant[]

  @@index([tournamentId])
  @@index([leagueId])
  @@map("matches")
}

model MatchParticipant {
  id               String               @id @default(cuid())
  matchId          String
  playerId         String
  teamId           String?
  participantType  MatchParticipantType @default(TEAM_MEMBER)
  teamMemberId     String?
  isWinner         Boolean
  score            Int?
  goals            Int?
  assists          Int?
  saves            Int?
  shots            Int?
  wasSubstitute    Boolean              @default(false)
  substituteReason String?              @db.Text
  playedAt         DateTime             @default(now())

  // Relationships
  match      Match       @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player     Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team       Team?       @relation(fields: [teamId], references: [id], onDelete: SetNull)
  teamMember TeamMember? @relation(fields: [teamMemberId], references: [id], onDelete: SetNull)

  @@index([playerId, matchId])
  @@index([teamId, matchId])
  @@index([playerId, wasSubstitute])
  @@map("match_participants")
}

model PlayerLeagueStats {
  id            String    @id @default(cuid())
  playerId      String
  leagueId      String
  matchesPlayed Int       @default(0)
  wins          Int       @default(0)
  losses        Int       @default(0)
  draws         Int       @default(0)
  winRate       Decimal   @db.Decimal(5, 4)
  totalGoals    Int       @default(0)
  totalAssists  Int       @default(0)
  totalSaves    Int       @default(0)
  totalShots    Int       @default(0)
  avgGoals      Decimal?  @db.Decimal(5, 2)
  avgAssists    Decimal?  @db.Decimal(5, 2)
  avgSaves      Decimal?  @db.Decimal(5, 2)
  lastMatchAt   DateTime?
  updatedAt     DateTime  @updatedAt

  // Relationships
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([playerId, leagueId])
  @@index([leagueId, wins])
  @@map("player_league_stats")
}

model PlayerLeagueRating {
  id            String    @id @default(cuid())
  playerId      String
  leagueId      String
  ratingSystem  String    @db.VarChar(50)
  currentRating Decimal   @db.Decimal(10, 2)
  ratingData    Json
  initialRating Decimal   @db.Decimal(10, 2)
  peakRating    Decimal?  @db.Decimal(10, 2)
  peakRatingAt  DateTime?
  matchesPlayed Int       @default(0)
  wins          Int       @default(0)
  losses        Int       @default(0)
  draws         Int       @default(0)
  lastMatchId   String?
  lastUpdatedAt DateTime  @updatedAt

  // Relationships
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([playerId, leagueId])
  @@index([leagueId, currentRating])
  @@map("player_league_ratings")
}

model Tournament {
  id              String           @id @default(cuid())
  leagueId        String
  name            String           @db.VarChar(200)
  description     String?          @db.Text
  status          TournamentStatus @default(UPCOMING)
  format          String?
  startDate       DateTime?
  endDate         DateTime?
  maxParticipants Int?
  createdAt       DateTime         @default(now())

  // Relationships
  league       League                  @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  participants TournamentParticipant[]
  matches      Match[]

  @@index([leagueId])
  @@map("tournaments")
}

model TournamentParticipant {
  id           String            @id @default(cuid())
  tournamentId String
  playerId     String?
  teamId       String?
  leagueId     String
  seed         Int?
  status       ParticipantStatus @default(ACTIVE)
  joinedAt     DateTime          @default(now())

  // Relationships
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  player     Player?    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team       Team?      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  league     League     @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, playerId])
  @@unique([tournamentId, teamId])
  @@map("tournament_participants")
}

model Organization {
  id          String   @id @default(cuid())
  leagueId    String
  name        String   @db.VarChar(200)
  tag         String?  @db.VarChar(20)
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  league  League               @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  members OrganizationMember[]
  teams   Team[]

  @@index([leagueId])
  @@map("organizations")
}

model OrganizationMember {
  id            String                  @id @default(cuid())
  organizationId String
  playerId      String
  leagueId      String
  status        OrganizationMemberStatus @default(ACTIVE)
  role          OrganizationMemberRole   @default(MEMBER)
  joinedAt      DateTime                 @default(now())
  leftAt        DateTime?
  approvedBy    String?                  @db.VarChar(20)
  approvedAt    DateTime?
  notes         String?                  @db.Text
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  player       Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  league       League       @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([organizationId, playerId])
  @@unique([playerId, leagueId])
  @@index([organizationId, status])
  @@index([leagueId, status])
  @@index([playerId, status])
  @@map("organization_members")
}
